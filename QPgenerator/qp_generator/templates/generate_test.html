{% extends 'base.html' %}
{% block title %}generate test{% endblock %}

{% block css %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css" rel="stylesheet" type="text/css".3.0/j />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/generate_test.css' %}">


    <style>
           
    </style>
{% endblock %}


{% block content %}
<br>

<div class="main">
<div class="container_fluid form_container my-5 mx-lg-5 px-5 py-3 ">
<!--School Name-->
    <div class="row justify-content-center">
        <div class="col-md-2">
                
        </div>
        <div class="col-md-8 ">
            <h3 style id="school_name"class="school" >{{school.school_name}}</h3>
        </div>
        <div class="col-md-2">
            <div class="form-check">
                <label class="form-check-label">
                  <input type="checkbox" id="hide_ans" class="form-check-input" value="">Hide Answers
                </label>
              </div>
        </div>
    </div>
<!--Heading exam name-->

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="input-group">                
                <textarea class="form-control" id="heading" aria-label="With textarea" placeholder="Exam Heading"></textarea>
            </div>
    
        </div>
    </div>
    
    
   <!--Grade--> 
    <div class="row justify-content-center mt-2">
        <div class="col-md-3 ">
            <div class="class">  
                <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text selector" for="inputGroupSelect01">Grade</label>
                        </div>
                        <select class="custom-select" id="class-sel"></select>
                </div> 
            </div>
        </div>
    </div>
             
<!--Time Subject date-->

    <div class="row align-items-center">
        <div class="col-md-4">
                
                <div class="input-group mb-3">
                        <div class="input-group-prepend">
                          <span class="input-group-text" id="basic-addon1">Time</span>
                        </div>
                        <input type="text" id="time" class="form-control" placeholder="eg:3hrs" aria-label="Username" aria-describedby="basic-addon1" >
                      </div>  
                        
                        
                    
        </div>
                                               
        
        <div class="col-md-4">
                <div class="input-group mb-3 ">
                            <div class="input-group-prepend">
                                <label class="input-group-text selector" for="subject-sel">Subject</label>
                            </div>
                            <select class="custom-select" id="subject-sel"></select>
                    </div> 
        </div>
     

        <div class="col-md-4">
                <div class="input-group mb-3">
                        <div class="input-group-prepend">
                          <span class="input-group-text" id="basic-addon1">Date</span>
                        </div>
                        <input type="text" id="date_ex" class="form-control" placeholder="dd/mm/yyyy" aria-label="Username" aria-describedby="basic-addon1">
                      </div> 
        </div>
    </div>


    <!--Instruction-->
    <div class="row justify-content-center">
        <div class="col-md-8">
                <div class="input-group">
                    
                        <textarea class="form-control" id="instruction" aria-label="With textarea" placeholder="Instructions"></textarea>
                      </div>

        </div>

    </div>

    
   

        

          

</div>

<hr style="display:block;border-width:5px;border-style:inset;">



<!--popover content-->
<div class="d-none popover" id="popover_content">
        <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <label class="input-group-text" for="inputGroupSelect01">Type</label>
                </div>
                <select class="custom-select" id="type_select">
                    <option value="mcq" id="sexy">Multiple choice questions</option>
                    <option value="short">Short Answers</option>
                    <option value="long">Long Answers</option>
                    <option value="Tf">True or False</option>
                    <option value="Match">Match the following</option>
                </select>
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-info" id="modal_trigger" data-toggle="modal" data-target="#exampleModal">
                Add
                </button>
        
        </div> 
</div>



      
<div class="dropdown d-none d-sm-block" id="show_sections">
  <button class="btn btn-primary dropdown-toggle" type="button" id="sections" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    All Sections
  </button>
  <div class="dropdown-menu" id="dropdown_menu1" aria-labelledby="dropdown_menu">
   <a href="#Section1"> <button class="dropdown-item" type="button">Section 1 </button></a>
    <a href="#Section2"><button class="dropdown-item" type="button">Section 2</button></a>
    <a href="#Section3"><button class="dropdown-item" type="button">Section 3</button></a>
  </div>
</div>


<!--All Sections-->
<div class= "container-fluid section my-5 px-5 py-3" marks="0" id="Section1">
    <div class="row justify-content-start ">

        <div  class="col-md-3">
         <h5 class="section_no" >Section_1</h5>
        </div>


        <div class="col-md-6 order-md-2 order-lg-2  order-xl-2 order-sm-2 order-3" >
            <div class="input-group mb-3  ">
                <input type="text" class="form-control section_heading" placeholder="Section Heading">
            </div>
        </div>

        <div class="col-md-2 offset-md-1 order-md-3 order-lg-3 order-xl-3 order-sm-3 order-2">
                <a tabindex="0" role="button" class="btn btn-info add_popover" data-placement="bottom" data-trigger="focus" data-toggle="popover" data-container="body" data-placement="left" data-html="true">Add Questions</a>   
        </div>

    </div>

    <div class="row justify-content-center ">
        <div class="col-md-8">
            <div class="input-group">
                <textarea class="form-control section_instruction" aria-label="With textarea" placeholder="Instructions"></textarea>
            </div>
        </div>
    </div>
    <div class="row justify-content-end px-4">

    <div class="d-flex flex-row-reverse px-4">
       <button class="btn btn-danger delete_section" style="float: right;" >Delete Section</button>
    </div></div>
    <div class="row justify-content-center ">
            <div class="col-md-11">
                <div class="questions border border-primary">
                <br><br>
                <h4 class="text-center">No Questions Added</h4>
                <br><br><br>
                </div>
            </div>
        </div>


</div>

<hr style="display:block;border-width:5px;border-style:inset;">


      
<div class= "container-fluid section  my-5 px-5 py-3" marks="0" id="Section2">
        <div class="row justify-content-start ">
    
            <div class="col-md-1">
              <h5 class="section_no">  Section_2 </h5>
            </div>
    
            <div class="col-md-6 offset-md-2 order-md-2 order-lg-2  order-xl-2 order-sm-2 order-3 ">
                <div class="input-group mb-3 ">
                    <input type="text" class="form-control section_heading" placeholder="Section Heading">
                </div>
            </div>
    
            <div class="col-md-2 offset-md-1 order-md-3 order-lg-3 order-xl-3 order-sm-3 order-2">
                    <a tabindex="0" role="button" class="btn btn-info add_popover" data-placement="bottom" data-trigger="focus" data-toggle="popover" data-container="body" data-placement="left" data-html="true">Add Questions</a>            </div>
    
        </div>
    
        <div class="row justify-content-center ">
            <div class="col-md-8">
                <div class="input-group">
                    <textarea class="form-control section_instruction" aria-label="With textarea" placeholder="Instruction"></textarea>
                </div>
            </div>
        </div>
        <div class="row justify-content-end px-4">

        <div class="d-flex flex-row-reverse px-4">
                <button class="btn btn-danger delete_section" style="float: right;" >Delete Section</button>
        </div></div>
        <div class="row justify-content-center ">
                <div class="col-md-11">
                    <div class="questions border border-primary">
                    <br><br>
                    <h4 class="text-center">No Questions Added</h4>
                    <br><br><br>
                    </div>
                </div>
            </div>
    
</div>

<hr style="display:block;border-width:5px;border-style:inset;">


<div class= "container-fluid section my-5 px-5 py-3" marks="0" id="Section3">
        <div class="row justify-content-start ">
    
            <div class="col-md-1">
              <h5 class="section_no">  Section_3</h5>
            </div>
    
            <div class="col-md-6 offset-md-2 order-md-2 order-lg-2  order-xl-2 order-sm-2 order-3">
                <div class="input-group mb-3 ">
                    <input type="text" class="form-control section_heading" placeholder="Section Heading">
                </div>
            </div>
    
            <div class="col-md-2 offset-md-1 order-md-3 order-lg-3 order-xl-3 order-sm-3 order-2">
                    <a tabindex="0" role="button" class="btn btn-info add_popover" data-placement="bottom" data-trigger="focus" data-toggle="popover" data-container="body" data-placement="left" data-html="true">Add Questions</a>            </div>
    
        </div>
    
        <div class="row justify-content-center ">
            <div class="col-md-8">
                <div class="input-group">
                    <textarea class="form-control section_instruction" aria-label="With textarea" placeholder="Instruction"></textarea>
                </div>
            </div>
        </div>
        <div class="row justify-content-end px-4">
        <div class="d-flex flex-row-reverse px-4 my-2">
                <button class="btn btn-danger delete_section" style="float: right;" >Delete Section</button>
        </div></div>
        <div class="row justify-content-center ">
                <div class="col-md-11">
                    <div class="questions border border-primary">
                    <br><br>
                    <h4 class="text-center">No Questions Added</h4>
                    <br><br><br>
                    </div>
                </div>
            </div>
    
</div>

<hr style="display:block;border-width:5px;border-style:inset;">

    

    

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">

                <div class="modal-header" style="background-color:rgb(138, 226, 219)";>
                <h5 style="color:rgb(29, 29, 109) ; font-weight:bold;font-family:'Song Myung', serif;"class="modal-title" id="exampleModalLabel">Enter number of questions required in each chapter</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" >
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>

                <div class="modal-body container" id="modal-content">
                    <div class="row justify-content-center">
                        <div class="fa-3x">
                            <i class="fas fa-spinner fa-spin"></i>
                            <i class="fas fa-circle-notch fa-spin"></i>
                            <i class="fas fa-sync fa-spin"></i>
                            <i class="fas fa-cog fa-spin"></i>
                            <i class="fas fa-spinner fa-pulse"></i>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="container">
                        <div class="row justify-content-center">
                            <div class="col-md-4 offset-md-6">
                                <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                  <span class="input-group-text" id="basic-addon1">Marks per question</span>
                                </div>
                                <input type="number" id="mpq" class="form-control"  aria-label="Username" aria-describedby="basic-addon1" >
                              </div> </div>
                              <div class="col-md-2">
                <button type="button" class="btn btn-info"id="add">Add</button></div>
                </div>
                </div>
                </div>

            </div>
        </div>
    </div>
</div>

<button type="button" class = "btn btn-primary btn-lg" id="add_section">Add Section</button>
<button id="pdf" class="btn btn-info btn-lg" style="float:right;">export to pdf</button>


<br>
<br>
<footer class="bg-dark text-white mt-4 ">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-md-3">
                    <h5>Contact info.</h5>           
                <ul>
                    <li>Jeya Surya-8451279365</li>
                    <li>Raj-8547622311</li>
                    <li>Happy-445151561</li>
                </ul>
                </div>
                 
                <div class="col-md-3 offset-md-6">
                    <h5>About us</h5>
                    <p>To create engaging products and services using interactive & digital platforms and establish a global presence.</p>
                </div>
            </div>
        </div>
    </footer>



{% endblock %}




{% block scripts %}
{% load static %}
<script src="{% static 'js/jquery-ajax-native.js' %}"></script>
<script src="{% static 'js/get_grades_and_subjects.js' %}"></script>

<script>


 // variables   
 var newdata    
 var q_type
 var grades
 var section_context
 var school_name
 var instruction
 var instruction1
 var time
 var date
 var heading
 var heading1
 var subject
 var grade
 var c=4
 var totalmarks=0
 var totalquestions=0
 var section_marks=[];

     
    $(function() {
      
                // date-picker function
                  $( "#date_ex" ).datepicker({
                    format:"dd/mm/yyyy"
                  });

                  //popover function

                  $("body").popover({
                    html: true, 
                    content: function() {
                            console.log($('#popover_content').html());
                            section_context = $(this);
                            return $('#popover_content').html();
                        },
                    selector: ".add_popover"
                });

                //add section function

                $("#add_section").click(function(){
                    $(".main").append(`
        <div class= "container-fluid section my-5 px-5"marks="0" id="Section${c}">
        <div class="row justify-content-start ">
    
            <div class="col-md-1">
             <h5 class="section_no">   Section_${c} </h5> 
            </div>
    
            <div class="col-md-6 offset-md-2">
                <div class="input-group mb-3 ">
                    <input type="text" class="form-control section_heading" placeholder="Section Heading">
                </div>
            </div>
    
            <div class="col-md-2 offset-md-1">
                <a tabindex="0" role="button" class="btn btn-info add_popover" data-placement="bottom" data-trigger="focus" data-toggle="popover" data-container="body" data-placement="left" data-html="true">Add Questions</a> 
            </div>
    
        </div>
    
        <div class="row justify-content-center ">
            <div class="col-md-8">
                <div class="input-group ">
                    <textarea class="form-control section_instruction" aria-label="With textarea" placeholder="Instructions"></textarea>
                </div>
            </div>
        </div>

        <div class="d-flex flex-row-reverse">
                <button class="btn btn-danger delete_section">Delete Section</button>
        </div>

        <div class="row justify-content-center ">
                <div class="col-md-12">
                    <div class="questions border border-primary">
                    <br><br>
                    <h4 class="text-center">No Questions Added</h4>
                    <br><br><br>
                    </div>
                </div>
        </div>
    

    
</div>

<hr style="display:block;border-width:5px;border-style:inset;">


                    `)

                    $("#dropdown_menu1").append(` 
                    <a href="#Section${c}"> <button class="dropdown-item" type="button">Section ${c} </button></a>`)

                    c++;

                });


                //delete section function

                $(document).on("click", ".delete_section", function(event){
                    console.log($(this).parents('.section'))

                    $(this).parents('.section').next('hr').remove();
                    $(this).parents('.section').remove();
                    c=1;
                    $('.section').each(function(){
                       $(this).attr("id",c);
                        $(this).find(".section_no").html(`Section_${c}`);
                        console.log(c);
                        c++;
                    })

                })

                //hide answer function

                $("#hide_ans").click(function(){
                    if($(this).is(':checked'))
                    {
                        $(".answer").hide()
                    }
                    else
                    {
                        $(".answer").show()
                    }
                })

                $('#show_sections').hover(function() {
                    $(this).find('.dropdown-menu').stop(true, true).delay(10).fadeIn(500);
                  }, function() {
                    $(this).find('.dropdown-menu').stop(true, true).delay(10).fadeOut(500);
                  });
                




        $(document).on("click", "#modal_trigger", function(event){
            q_type=$(".popover-body").find("select").val();
            console.log(q_type);
            fetch_chapters()
            $(this).parents(".popover").popover('hide');
            });






            function fetch_chapters(){
                grade_id = $("#class-sel").val()
                
                subject_id = $("#subject-sel").val()
                console.log(grade_id)
                console.log(subject_id)
                console.log(q_type)
                $.ajax({
                url: "{% url 'load_chapters_test' %}",
                    data: {
                        "grade" : grade_id,
                        "subject" : subject_id,
                        "type"  : q_type
                    },
                    success: function(data){
                        console.log(data);
                        newdata=data
                        $("#modal-content").html(
                            `<div class="container table-responsive ">
                            <table  id= "table1" class="table table-sm thead-dark">
                                <thead class="thead-dark">
                                    <tr id="table_heading"  >
                                            <th scope="col">#</th>
                                        <th align="center">Chapter</th>
                                        <th align="center" >Easy Questions</th>
                                        <th align="center">Medium Questions</th>
                                        <th align="center">Tough Questions</th>
                                    </tr>
                                </thead>
                                </table> 
                            </div>
                            `
                        )
                        for (i = 0; i < data.ids.length; i++) {                        
                            $("#table1").append(` <tr align="center" id="chpt_name">
                                    <th scope="col">${i+1}</th>
                                <td width="40%" >${data.names[i]}</td>
                            
                                <td  width="20%" >${data.easy[i]} <input type="number" class="mx-1" style="width: 55px;text-align:center; " id="easy${i}"></td>
                                <td  width="20%">${data.medium[i]} <input type="number" class="mx-1" style="width: 55px;text-align:center; "  id="medium${i}"> </td>
                                <td  width="20%">${data.hard[i]} <input type="number" class="mx-1" style="width: 55px;text-align:center; "  id="hard${i}"></td>
                                </tr>`);
                           
                        }  
                                            
    



                    }
                });
                
             }







      
        $(document).on("click", "#add", function(event){
            var a=[];
            totalquestions=0
            var mpq=$("#mpq").val();
            for (j=0;j<newdata.ids.length;j++){
                var easy = $("#easy"+j).val();
                var medium = $("#medium"+j).val();
                var hard = $("#hard"+j).val();
                

                if (easy==null || easy=="")
                {
                    easy=0;
                    
                }
                if( medium==null || medium=="")
                {
                    medium=0;
                    
                }
                if(hard==null || hard=="")
                {
                    hard=0;
                }
                if(easy%1!=0 ||  easy<0 || easy>newdata.easy[j])
                {
                alert("Enter proper data in 1");
                return;
                }

                if(medium%1!=0|| medium<0 || medium>newdata.medium[j])
                {
                alert("Enter proper data in 2");
                return;
                }
                
                if(hard%1!=0 || hard<0 || hard>newdata.hard[j])
                {
                alert("Enter proper data in 3");
                return;
                }
                totalquestions=totalquestions + parseInt(easy)+ parseInt(medium)+ parseInt(hard);
                

                var obj={
                    "id":newdata.ids[j],
                    "easy":easy,
                    "medium":medium,
                    "hard":hard
                };
                a.push(JSON.stringify(obj));

            }

            if( mpq == null || mpq<=0 || mpq==""){
                alert("Enter proper data in marks per question field");
                return;
            }

            totalmarks=totalquestions*parseInt(mpq);
            section_context.parents(".section").attr("marks",totalmarks);

            console.log(totalquestions);
            $('#exampleModal').modal('hide');
            $.ajax({
                url: "{% url 'random_questions' %}",
                data: {
                    "chapters_list":a,
                    "type":q_type},
                    
                success: function(data){
                    
                    $question_section = section_context.parents(".section").find(".questions")
                    $question_section.html(data)
                    marks_string=""+totalquestions+" x "+mpq+" = "+totalmarks+" marks"
                    $question_section.find(".section_marks").html(marks_string)
                    $('html, body').animate({
                        scrollTop: $question_section.offset().top - 300
                    }, 1000);
                }   
            });
        });

        
            var full_marks=0;
      
        $("#pdf").click(function(){
            console.log($("#mcq").html());
            console.log($("#paper").html());
            var questions;
            school_name=$("#school_name").html()
            heading=$("#heading").val()
            grade=$("#class-sel option:selected").text()
            subject=$("#subject-sel option:selected").text()
            time=$("#time").val()
            date=$("#date_ex").val()
            instruction=$("#instruction").val().replace(/\n/g,'<br>')
            $(".section").each(function(){
                full_marks= full_marks+parseInt($(this).attr("marks"));
            })
            var htmlString=`
            <!DOCTYPE html>
            <html>
            <head>
	        <title>question paper
	        </title>
            </head>
            <body>
               
                <h2 style="text-align:center; font-family: Times New Roman, Times, serif; color:black">${school_name}</h2>
                <div style="width:100%; text-align:center; margin-bottom:5px;">
               <div style="  float:left; width:250px;   font-size:22px; font-family: Times New Roman, Times, serif;color:black;font-weight:bold;"> Date:${date}</div>  
               <div style=" display: inline-block;margin:0 auto; width:400px;font-size:25px; font-family: Times New Roman, Times, serif;color:black;font-weight:bold;">  ${heading}</div>
               <div style="  float:right; width:250px; font-size:22px ;font-family: Times New Roman, Times, serif;color:black;font-weight:bold;"> Time:${time}</div>
                </div>
                
                <div style="width:100%; text-align:center;">
                        <div style="  float:left; width:250px;   font-size:22px; font-family: Times New Roman, Times, serif;color:black;font-weight:bold;"> Subject:${subject}</div>  
                        <div style=" display: inline-block;margin:0 auto; width:400px;font-size:25px; font-family: Times New Roman, Times, serif;color:black;font-weight:bold;"> Class- ${grade}</div>
                        <div style="  float:right; width:250px; font-size:22px ;font-family: Times New Roman, Times, serif;color:black;font-weight:bold;"> ${full_marks} marks</div>
                         </div>
                    
                    <br>
                    

                 
                    <hr style="border-width:2px;">   
                    <h5 style="font-weight:bold ;text-align:center; color:black;"> General Instructions:</h5>
                <p style="text-align: center; font:italic">${instruction} </p>
                    <hr style="border-width:2px;">   
               
               
                <br>`






                
            $(".section").each(function(){
                
            questions=$(this).find(".questions").html();
            console.log($(this).find(".questions").find('.text-center').html());
            if($(this).find(".questions").find('.text-center').html()=="No Questions Added")
            {   console.log("returned");
                return;
            }
            heading1=$(this).find(".section_heading").val();
            instruction1=$(this).find(".section_instruction").val().replace(/\n/g,'<br>')
            htmlString = htmlString+`
            <h3 style="text-align:center; font-weight:bold;margin-bottom:5px; color:black;">${heading1}</h3>
                    <p style="text-align: center; margin-bottom:5px;"> ${instruction1}</p>
                        ${questions}
                        <hr style="border-width:2px;">  `;
            });

            




htmlString=htmlString+`</body>
</html>`;
console.log(htmlString);
            $.ajax({
                dataType: 'native',
                url : "{% url 'to_pdf' %}",
                data : {
                    "html_data" : htmlString,
                    "heading" : heading,
                    "grade" : $("#class-sel option:selected").val(),
                    "subject" : $("#subject-sel option:selected").val(),
                    "date" : date
                },
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(blob){
                    console.log(blob.size);
                    var link=document.createElement('a');
                    link.href=window.URL.createObjectURL(blob);
                    link.download="question_paper_" + new Date() + ".pdf";
                    document.body.appendChild(link);
                    link.click();
                }
            });
        });

   
    });
    

</script>
{% endblock %}
